#!/bin/sh

depend @linux @ramfs @net

prebuild(){
  # (: reset build / copy skeleton :)
  rm -rf $DESTDIR
  rm -rf $DESTDIR
  mkdir -p $DESTDIR; }

postinstall(){
  # (: tweak skeleton :)
  echo $DESTARCH_MULTI > $DESTDIR/etc/arch
  echo /lib            > $DESTDIR/etc/ld.so.conf
  head -n1 /etc/passwd > $DESTDIR/etc/passwd
  head -n1 /etc/group  > $DESTDIR/etc/group;
  [ -d $BWD/_local ] && cp -r $BWD/_local/* $DESTDIR/
  true; }

preimage(){
  # (: here we count versions :D :)
  _version_increment
  echo $VERSION >$DESTDIR/etc/version
  echo $RELEASE >$DESTDIR/etc/release
  # (: setup /bin and /etc/rc :)
  chmod a+x $DESTDIR/etc/rc
  chmod a+x $DESTDIR/bin/*
  # (: setup /lib (ldconfig) :)
  # FIXME: ldconfig wont work for cross-compiling to armpi2
  ldconfig.real -r $DESTDIR -f etc/ld.so.conf -c etc/ld.so.cache
  # WORKAROUND: good old link-frenzy in /lib
  ( cd $DESTDIR/lib
    for lib in $(ls *.so.*)
    do local p=
      p=$(echo $lib | sed 's/.[0-9]\+.[0-9]\+.[0-9]\+$//'); [ -e "$p" ] || ln -s "$lib" "$p"
      p=$(echo $lib | sed 's/.[0-9]\+.[0-9]\+$//');         [ -e "$p" ] || ln -s "$lib" "$p"
      p=$(echo $lib | sed 's/.[0-9]\+$//');                 [ -e "$p" ] || ln -s "$lib" "$p"
    done; )
  # FIXME: remove ugear spash
  rm -rf $DESTDIR/lib/u $DESTDIR/bin/busybox $DESTDIR/bin/usplash
  # (: pack it up :)
  pack_$DESTARCH; }

image(){
  # (: build squashfs-image :)
  printf "${_BPP}[\e[32mbuilding gearos\e[0m] " >&2
  rm -f  $SOURCES/gearos.img
  ( cd $DESTDIR; mksquashfs ./ $SOURCES/gearos.img -all-root -comp xz; )
  printf "${_BPP}\e[1;41m GEAR\e[44m%s\e[45m%s \e[0m $SOURCES/gearos.img \e[1;41m %s \e[0m\n" $VERSION $RELEASE $(du -h $SOURCES/gearos.img|cut -f1) >&2; }

tests(){ _run_kvm -x; }

poststick(){ _arch_hook stick; }
