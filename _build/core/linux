#!/bin/sh
# gearos linux kernel buildscript

install(){
  [ -d $DESTDIR/lib/modules -a -d $DESTDIR/lib/firmware ] && return 0
  mkdir -p $DESTDIR/lib/modules                      &&
  cp -r /lib/firmware $DESTDIR/lib/  && _ok firmware &&
  _arch_hook linux_install; }

ramfs(){
  [ $KERNEL_FORMAT = blob ] || return 0
  _steal_kmods $RAMFS *overlay.ko *squashfs.ko *virtio-input.ko; }

# this is somewhat hooked :)
install_default() { :; }
setup_default()   { :; }
deps_default()    { :; }

_arch_include linux

_is_app bc || apt-get install bc build-essential

_arch_hook linux_deps
_arch_hook linux_setup

[ -n "$KERNEL_FORMAT" ] || KERNEL_FORMAT=bzImage
[ -n "$KERNEL_IMAGE"  ] || KERNEL_IMAGE=$SOURCES/linux/arch/$DESTARCH_COMMON/boot/$KERNEL_FORMAT
[ -n "$KERNEL_EMU"    ] || KERNEL_EMU=$KERNEL_IMAGE

export KERNEL_FORMAT KERNEL_IMAGE KERNEL_EMU
