#!/bin/sh
# gearos busybox buildscript

BB_SOURCES=$SOURCES/busybox

build(){
  _git_source busybox git://git.busybox.net/busybox -b 1_23_stable
  _depend_apt tmux
  _depend_apt tic ncurses-bin
  [ -f $BB_SOURCES/busybox ] && return 0
  [ -f $BB_SOURCES/.config ] || {
    cat $(_arch_file busybox_config) |
    sed 's|CONFIG_SYSROOT=""|CONFIG_SYSROOT="'$SYSROOT'"|' \
    > $BB_SOURCES/.config
    _make -C $BB_SOURCES menuconfig; }
  _make -C $BB_SOURCES; }

reconfigure(){
  _make -C $BB_SOURCES menuconfig clean; }

install(){
  # copy terminfo
  _steal_app tic tmux
  cp -r /lib/terminfo $DESTDIR/lib/
  # copy tmux
  _steal_app tmux
  # install busybox
  cp $BB_SOURCES/busybox $DESTDIR/bin/
  [ -d $DEBIAN ] && cp $BB_SOURCES/busybox $DEBIAN/bin/
  _exec_debroot "/bin/busybox --list-full | sed 's/.*\\///'" 2>&1 |
  while read item
    do [ -z "$item" ] && continue; printf ",\e[33m$item\e[0m"
    ln -f "$DESTDIR/bin/busybox" "$DESTDIR/bin/$item" || exit 1
  done
  # replace switch-root
  for f in switch_root; do rm -f $DESTDIR/bin/$f;done
  _steal_app switch_root
  ozh; }

ozh(){
  mkdir -p $DESTDIR/etc/ozh/core
  repo="https://raw.githubusercontent.com/hakt0r/ozh-core/master";
  [ -f $SOURCES/ozh ] ||
  $(which wget) "$repo/core" -O $SOURCES/ozh &&
  cp $SOURCES/ozh $DESTDIR/etc/ozh/core/core; }
